---
title: "Untargeted control doc"
author: "William Kumler"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, purl=FALSE)
options(pillar.sigfig=7)
options(readr.num_columns = 0)
options(readr.show_col_types = FALSE)
library(tidyverse)
library(data.table)
library(arrow)
library(xcms)
library(RaMS)

polarity <- "pos"
# polarity <- "neg"
amendment <- "Amm"
# amendment <- "Nit"
# amendment <- "GMP"
# amendment <- "Arg"
IS_type <- "noIS"
# IS_type <- "wIS"

parametadata <- read_csv("metadata/parametadata.csv") %>% 
  filter(polarity==!!polarity) %>%
  filter(amendment==!!amendment) %>%
  filter(IS_type==!!IS_type)

chosen_stans <- read_csv("metadata/all_stans.csv") %>%
  filter(polarity==!!polarity)

output_folder <- paste(amendment, polarity, IS_type, "output", sep = "_") %>%
  paste0("untargeted/", ., "/")
if(!dir.exists(output_folder))dir.create(output_folder)
output_csv_write <- function(object){
  obj_name <- deparse(substitute(object))
  write_csv(object, file = paste0(output_folder, obj_name, ".csv"))
}

xcms_file_data <- parametadata %>%
  filter(amendment==!!amendment) %>%
  filter(polarity==!!polarity) %>%
  filter(IS_type==!!IS_type) %>%
  mutate(samp_group=paste(amendment, depth, startime, timepoint, sep="-"))
```

```{r xcms}
parallel_param <- SnowParam(
  workers = parallel::detectCores()-1, 
  tasks = nrow(xcms_file_data), 
  progressbar = TRUE
)

register(BPPARAM = SerialParam(progressbar = TRUE))
msnexp <- readMSData(
  files = xcms_file_data$filepath, 
  pdata = new("NAnnotatedDataFrame", xcms_file_data), 
  msLevel. = 1, 
  mode = "onDisk"
)

cwp <- CentWaveParam(
  ppm = 5, 
  peakwidth = c(20, 80), 
  prefilter = c(3, 1e5), 
  snthresh = 0, 
  verboseColumns = TRUE, 
  extendLengthMSW = TRUE, 
  integrate = 2,
  verboseBetaColumns = TRUE
)
msnexp_withpeaks <- findChromPeaks(msnexp, cwp, BPPARAM=parallel_param)

# mid_file <- xcms_file_data %>%
#   arrange(abs(timestamp-mean(timestamp))) %>%
#   select(filename, timestamp) %>%
#   slice(1) %>%
#   pull(filename)
# mid_file_idx <- which(basename(fileNames(msnexp_filled))==mid_file)
# obp <- ObiwarpParam(binSize = 1, response = 1, distFun = "cor_opt", 
#                     centerSample = mid_file_idx)
# msnexp_rtcor <- adjustRtime(msnexp_withpeaks, obp)

register(BPPARAM = SerialParam(progressbar = TRUE))
pdp <- PeakDensityParam(
  sampleGroups = xcms_file_data$samp_group, 
  bw = 12, 
  minFraction = 0, 
  binSize = 0.001, 
  minSamples = 2
)
msnexp_grouped <- groupChromPeaks(msnexp_withpeaks, pdp)

fpp <- FillChromPeaksParam(ppm = 10)
msnexp_filled <- fillChromPeaks(msnexp_grouped, fpp, BPPARAM=parallel_param)

saveRDS(msnexp_filled, paste0(output_folder, "msnexp_filled.rds"))
```

```{r xcms QC, eval=FALSE}
msnexp_filled <- readRDS(paste0(output_folder, "msnexp_filled.rds"))
```

```{r making peak_data and feat_data}
msnexp_filled <- readRDS(paste0(output_folder, "msnexp_filled.rds"))
peak_data_long <- msnexp_filled %>%
  chromPeaks() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  mutate(peakidx=row_number())
peak_data <- msnexp_filled %>%
  featureDefinitions() %>%
  as.data.frame() %>%
  select(mzmed, rtmed, npeaks, peakidx) %>%
  rownames_to_column("id") %>%
  unnest_longer(peakidx) %>%
  rename_with(~paste0("feat_", .x), .cols = -peakidx) %>%
  dplyr::rename(feature="feat_id") %>%
  left_join(peak_data_long, by = join_by(peakidx)) %>%
  mutate(filename=basename(fileNames(msnexp_filled))[sample])
output_csv_write(peak_data)

all_feat_data <- peak_data %>%
  left_join(parametadata) %>%
  filter(samp_type=="Smp") %>%
  group_by(feature) %>%
  summarize(mzmed=unique(feat_mzmed), rtmed=unique(feat_rtmed)/60, n=n(),
            med_cor=median(beta_cor, na.rm=TRUE), 
            med_snr=median(beta_snr, na.rm=TRUE))
# all_feat_data %>%
#   # filter(med_cor>0.75) %>%
#   mutate(n_group=cut(n, breaks = c(0, 2, 10, 40, 60, 62, 100, 130, Inf))) %>%
#   ggplot(aes(label=feature)) +
#   geom_point(aes(x=med_cor, y=med_snr, color=n_group))

best_feat_data <- all_feat_data %>%
  filter(med_cor>0.75) %>%
  select(-med_cor, -med_snr)
output_csv_write(best_feat_data)
```

```{r diagnostic plots}
mass_check <- function(mz_i){
  mass_feats <- best_feat_data %>% 
    filter(mzmed%between%pmppm(mz_i, 5)) %>%
    print()
  chosen_eic <- open_dataset("tmzMLs/pqds") %>%
    filter(polarity==!!polarity) %>%
    filter(amendment==!!amendment) %>%
    filter(mz%between%pmppm(mz_i, 5)) %>%
    filter(rt%between%c(2, 20)) %>%
    dplyr::collect()
  ggtitle_i <- ifelse(is.null(names(mz_i)), mz_i, names(mz_i))
  chosen_eic %>%
    left_join(parametadata, by = join_by(filename, samp_type, amendment, polarity)) %>%
    mutate(samp_type=str_extract(filename, "Mix\\d|Deep|Surf|Poo|Blk")) %>%
    filter(!str_detect(filename, "Mat")) %>%
    mutate(plot_facet=ifelse(samp_type%in%c("Mix1", "Mix2"), "Mixes", "Samples")) %>%
    ggplot() +
    geom_line(aes(x=rt, y=int, group=filename, color=samp_type)) +
    facet_wrap(~plot_facet, scales = "free_y", ncol=1) +
    geom_vline(aes(xintercept=rtmed), color="black", data = mass_feats) +
    ggtitle(ggtitle_i) +
    theme_bw()
}
mass_check(c("Carn/THB/HMSB"=162.1125))
mass_check(c("ACH/TMAB"=146.1181))
mass_check(c("Ala/bAla/Sarc"=90.0555))
mass_check(c("Arg"=175.119501))
mass_check(c("Leu/Ile/TMAP"=132.1025))
mass_check(c("15N Ile"=132.1025+0.997))
```


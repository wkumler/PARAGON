---
title: "Untargeted control doc"
author: "William Kumler"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, purl=FALSE)
options(pillar.sigfig=7)
options(readr.num_columns = 0)
options(readr.show_col_types = FALSE)
library(tidyverse)
library(data.table)
library(arrow)
library(xcms)
library(RaMS)

# polarity <- "pos"
polarity <- "neg"
# amendment <- "Amm"
amendment <- "Nit"
# amendment <- "GMP"
# amendment <- "Arg"
IS_type <- "noIS"
# IS_type <- "wIS"

parametadata <- read_csv("metadata/parametadata.csv") %>% 
  filter(polarity==!!polarity) %>%
  filter(amendment==!!amendment) %>%
  filter(IS_type==!!IS_type)

chosen_stans <- read_csv("metadata/all_stans.csv") %>%
  filter(polarity==!!polarity)

output_folder <- paste(amendment, polarity, IS_type, "output", sep = "_") %>%
  paste0("untargeted/", ., "/")
if(!dir.exists(output_folder))dir.create(output_folder)
output_csv_write <- function(object){
  obj_name <- deparse(substitute(object))
  write_csv(object, file = paste0(output_folder, obj_name, ".csv"))
}

xcms_file_data <- parametadata %>%
  filter(amendment==!!amendment) %>%
  filter(polarity==!!polarity) %>%
  filter(IS_type==!!IS_type) %>%
  mutate(samp_group=paste(amendment, depth, startime, timepoint, sep="-"))
```

```{r xcms}
parallel_param <- SnowParam(
  workers = parallel::detectCores()-1, 
  tasks = nrow(xcms_file_data), 
  progressbar = TRUE
)

register(BPPARAM = SerialParam(progressbar = TRUE))
msnexp <- readMSData(
  files = xcms_file_data$filepath, 
  pdata = new("NAnnotatedDataFrame", xcms_file_data), 
  msLevel. = 1, 
  mode = "onDisk"
)

cwp <- CentWaveParam(
  ppm = 5, 
  peakwidth = c(20, 80), 
  prefilter = c(3, 1e5), 
  snthresh = 0, 
  verboseColumns = TRUE, 
  extendLengthMSW = TRUE, 
  integrate = 2,
  verboseBetaColumns = TRUE
)
msnexp_withpeaks <- findChromPeaks(msnexp, cwp, BPPARAM=parallel_param)

# mid_file <- xcms_file_data %>%
#   arrange(abs(timestamp-mean(timestamp))) %>%
#   select(filename, timestamp) %>%
#   slice(1) %>%
#   pull(filename)
# mid_file_idx <- which(basename(fileNames(msnexp_filled))==mid_file)
# obp <- ObiwarpParam(binSize = 1, response = 1, distFun = "cor_opt", 
#                     centerSample = mid_file_idx)
# msnexp_rtcor <- adjustRtime(msnexp_withpeaks, obp)

register(BPPARAM = SerialParam(progressbar = TRUE))
pdp <- PeakDensityParam(
  sampleGroups = xcms_file_data$samp_group, 
  bw = 12, 
  minFraction = 0, 
  binSize = 0.001, 
  minSamples = 2
)
msnexp_grouped <- groupChromPeaks(msnexp_withpeaks, pdp)

fpp <- FillChromPeaksParam(ppm = 10)
msnexp_filled <- fillChromPeaks(msnexp_grouped, fpp, BPPARAM=parallel_param)

saveRDS(msnexp_filled, paste0(output_folder, "msnexp_filled.rds"))
```

```{r xcms QC, eval=FALSE}
msnexp_filled <- readRDS(paste0(output_folder, "msnexp_filled.rds"))
```

```{r making peak_data and best_feat_data}
msnexp_filled <- readRDS(paste0(output_folder, "msnexp_filled.rds"))
peak_data_long <- msnexp_filled %>%
  chromPeaks() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  mutate(peakidx=row_number())
peak_data <- msnexp_filled %>%
  featureDefinitions() %>%
  as.data.frame() %>%
  select(mzmed, rtmed, npeaks, peakidx) %>%
  rownames_to_column("id") %>%
  unnest_longer(peakidx) %>%
  rename_with(~paste0("feat_", .x), .cols = -peakidx) %>%
  dplyr::rename(feature="feat_id") %>%
  left_join(peak_data_long, by = join_by(peakidx)) %>%
  mutate(filename=basename(fileNames(msnexp_filled))[sample]) %>%
  select(feature, feat_mzmed, feat_rtmed, feat_npeaks, filename,
         mz, mzmin, mzmax, rt, rtmin, rtmax, into, sn, beta_cor, beta_snr)
output_csv_write(peak_data)

all_feat_data <- peak_data %>%
  left_join(parametadata) %>%
  filter(samp_type=="Smp") %>%
  group_by(feature) %>%
  summarize(mzmed=unique(feat_mzmed), rtmed=unique(feat_rtmed)/60, n=n(),
            med_cor=median(beta_cor, na.rm=TRUE), 
            med_snr=median(beta_snr, na.rm=TRUE))
output_csv_write(all_feat_data)
# all_feat_data %>%
#   # filter(med_cor>0.75) %>%
#   mutate(n_group=cut(n, breaks = c(0, 2, 10, 40, 60, 62, 100, 130, Inf))) %>%
#   ggplot(aes(label=feature)) +
#   geom_point(aes(x=med_cor, y=med_snr, color=n_group))

# Rescue feats
if(amendment=="Amm"){
  if(polarity=="pos"){
    rescue_feats <- c("FT3015", Allopurinol="FT1319", Hypoxanthine="FT1321",
                      `DMSOP`="FT1688", "Guan from guan"="FT1707", Tyrosine="FT2200",
                      Phosphocholine="FT2228", Trimethyllysine="FT2278",
                      Dexpanthenol="FT2426", Cytidine="FT2792",
                      Mycogly='FT2814', Inosine="FT2960", Guanosine="FT3015")
  } else if(polarity=="neg"){
    rescue_feats <- c()
  }
}
if(amendment=="Nit"){
  if(polarity=="pos"){
    rescue_feats <- c()
  } else if(polarity=="neg"){
    rescue_feats <- c(Bisulfate="FT0706", "Itaconic acid"="FT1544", 
                      "Salicylic"="FT1841")
  } else {
    stop("Unknown polarity")
  }
}
if(amendment=="GMP"){
  if(polarity=="pos"){
    
  } else if(polarity=="neg"){
    
  } else {
    stop("Unknown polarity")
  }
}
if(amendment=="Arg"){
  if(polarity=="pos"){
    
  } else if(polarity=="neg"){
    
  } else {
    stop("Unknown polarity")
  }
}

best_feat_data <- all_feat_data %>%
  filter(med_cor>0.75 | feature%in%rescue_feats) %>%
  select(-med_cor, -med_snr)
output_csv_write(best_feat_data)
```

```{r rescue feats rendering}
anno_manu <- readxl::read_excel("untargeted/manual_annotations.xlsx") %>%
  filter(polarity==!!polarity) %>%
  filter(amendment==!!amendment)
all_feat_data <- read_csv(paste0(output_folder, "all_feat_data.csv"))
anno_manu %>%
  filter(str_detect(notes, "[Rr]escue"))
all_feat_data %>%
  filter(mzmed%between%pmppm(137.0239, 10))
```


```{r plots from mass check and others, eval=FALSE}
best_feat_data %>%
  ggplot() +
  geom_point(aes(x=rtmed, y=mzmed, color=log10(n))) +
  scale_color_viridis_c()

mass_check <- function(mz_i, all_samps=FALSE){
  mass_feats <- best_feat_data %>% 
    filter(mzmed%between%pmppm(mz_i, 5)) %>%
    print()
  if(all_samps){
    chosen_eic <- open_dataset("tmzMLs/pqds") %>%
      filter(polarity==!!polarity) %>%
      filter(amendment==!!amendment) %>%
      filter(mz%between%pmppm(mz_i, 5)) %>%
      filter(rt%between%c(2, 20)) %>%
      dplyr::collect()
  } else {
    chosen_eic <- open_dataset("tmzMLs/pqds") %>%
      filter(polarity==!!polarity) %>%
      filter(amendment==!!amendment) %>%
      filter(samp_type=="Poo" | samp_type=="Std") %>%
      filter(mz%between%pmppm(mz_i, 5)) %>%
      filter(rt%between%c(2, 20)) %>%
      dplyr::collect()
  }
  ggtitle_i <- ifelse(is.null(names(mz_i)), mz_i, names(mz_i))
  chosen_eic %>%
    left_join(parametadata, by = join_by(filename, samp_type, amendment, polarity)) %>%
    mutate(samp_type=str_extract(filename, "Mix\\d|Deep|Surf|Poo|Blk")) %>%
    filter(!str_detect(filename, "Mat")) %>%
    mutate(plot_facet=ifelse(samp_type%in%c("Mix1", "Mix2"), "Mixes", "Samples")) %>%
    ggplot() +
    geom_line(aes(x=rt, y=int, group=filename, color=samp_type)) +
    facet_wrap(~plot_facet, scales = "free_y", ncol=1) +
    geom_vline(aes(xintercept=rtmed), color="black", data = mass_feats) +
    scale_x_continuous(breaks = 2:20) +
    ggtitle(ggtitle_i) +
    theme_bw()
}

best_feat_data %>% slice_sample(n=1) %>% pull(mzmed) %>% mass_check()

mass_check(c("Carn/THB/HMSB"=162.1125))
mass_check(c("ACH/TMAB"=146.1181), all_samps = TRUE)
mass_check(c("Ala/bAla/Sarc"=90.0555))
mass_check(c("Arg"=175.119501))
mass_check(c("Leu/Ile/TMAP"=132.1025))
mass_check(c("15N Ile"=132.1025+0.997))
mass_check(60.04510)
mass_check(c("Ectoine"=143.0821))
mass_check(c("Betonicine"=160.0974))
mass_check(c("Adenine"=136.0623))
mass_check(c("Pyroglut"=130.0504))
mass_check(c("Glutamine"=147.076968))
mass_check(c("Cytosine"=244.093347))
mass_check(c("Proline"=116.0712))
```

```{r annotate}
all_stans <- read_csv("metadata/all_stans.csv") %>%
  mutate(polarity=factor(polarity, levels=c("pos", "neg"))) %>%
  arrange(polarity) %>%
  filter(compound_type!="Internal Standard")
# map(c("Amm", "Nit", "GMP", "Arg"), function(amendment_i){
#   all_stans %>%
#       mutate(amendment=amendment_i) %>%
#       select(amendment, polarity, compound_name, mz, rt, date_added, mix) %>%
#       write_csv("untargeted/anno_template.csv", append = TRUE)
# })
# # Gets copy-pasted into the Excel file manual_annotations.xlsx
# # Then run eicscript.R to render the EICs for each standard and fill it in
# # Afterward, use the "rescue_feats" object above to add those that didn't
# # pass QC for shape or SNR back in

manual_anno <- readxl::read_excel("untargeted/manual_annotations.xlsx")
manual_anno %>% filter(str_detect(notes, "Unpicked"))
```

```{r check anno}
all_stans <- read_csv("metadata/all_stans.csv") %>%
  filter(polarity==!!polarity) %>%
  filter(compound_type!="Internal Standard")
manual_anno <- readxl::read_excel("untargeted/manual_annotations.xlsx") %>%
  filter(polarity==!!polarity) %>%
  filter(amendment==!!amendment)
best_feat_data <- output_folder %>%
  paste0("best_feat_data.csv") %>%
  read_csv()
mz_rt_check_df <- best_feat_data %>%
  left_join(manual_anno) %>%
  select(feature, compound_name, mzmed, rtmed) %>%
  filter(!is.na(compound_name)) %>%
  left_join(all_stans) %>%
  select(feature, compound_name, mzmed, rtmed, mz, rt)
mz_rt_check_df %>%
  ggplot(aes(label=compound_name)) +
  geom_point(aes(x=rtmed, y=rt)) +
  geom_abline(slope = 1) +
  coord_fixed()
mz_rt_check_df %>%
  ggplot(aes(label=compound_name)) +
  geom_point(aes(x=mzmed, y=mz-mzmed))
```

```{r find isotopes (stans only)}
all_stans <- read_csv("metadata/all_stans.csv") %>%
  filter(polarity==!!polarity) %>%
  filter(compound_type!="Internal Standard") %>%
  select(compound_name, formula)
manual_anno <- readxl::read_excel("untargeted/manual_annotations.xlsx") %>%
  filter(polarity==!!polarity) %>%
  filter(amendment==!!amendment) %>%
  select(feature, compound_name)
best_feat_data <- output_folder %>%
  paste0("best_feat_data.csv") %>%
  read_csv() %>%
  left_join(manual_anno) %>%
  left_join(all_stans)
peak_rt_bounds <- output_folder %>%
  paste0("peak_data.csv") %>%
  read_csv() %>%
  select(feature, filename, rtmin, rtmax) %>%
  distinct()
iso_mzs <- best_feat_data %>%
  filter(!is.na(formula)) %>%
  mutate(n_count=str_extract(formula, "N\\d+")) %>%
  mutate(n_count=as.numeric(str_remove(n_count, "N"))) %>%
  mutate(n_count=ifelse(str_detect(formula, "N") & is.na(n_count), 1, n_count)) %>%
  filter(!is.na(n_count)) %>%
  slice(rep(seq(n()), n_count+1)) %>%
  group_by(feature) %>%
  mutate(n_count=1:n()) %>%
  mutate(labeled_mzmed=mzmed+0.997025*(n_count-1)) %>%
  select(compound_name, feature, labeled_mzmed, n_count) %>%
  left_join(peak_rt_bounds, relationship = "many-to-many") %>%
  left_join(parametadata) %>%
  filter(samp_type=="Smp") %>%
  select(compound_name, feature, n_count, labeled_mzmed, filename, rtmin, rtmax)

iso_areas <- iso_mzs %>%
  split(.$filename) %>% 
  imap(function(file_peaks, file_name_i){
    msdata <- open_dataset("tmzMLs/pqds") %>%
      filter(amendment=="Amm") %>%
      filter(polarity=="pos") %>%
      filter(filename==file_name_i) %>%
      dplyr::collect()
    file_peaks %>%
      pmap(function(...){
        row_data <- data.frame(...)
        area <- msdata[mz%between%pmppm(row_data$labeled_mzmed, 100)] %>%
          .[rt%between%c(row_data$rtmin/60, row_data$rtmax/60)] %>%
          .[,sum(int)]
        cbind(row_data, area=area)
      }) %>%
      bind_rows()
  }, .progress=TRUE) %>%
  bind_rows() %>%
  select(compound_name, filename, area, n_count)

output_csv_write(iso_areas)

iso_areas %>%
  filter(compound_name=="L-Arginine") %>%
  left_join(parametadata) %>%
  filter(!is.na(depth)) %>%
  mutate(timepoint=factor(timepoint, levels=paste0("T", c(0,1,3,10,26)))) %>%
  ggplot() +
  geom_boxplot(aes(x=factor(n_count), y=area, color=timepoint)) +
  facet_grid(depth~startime, scales="free_y")
```



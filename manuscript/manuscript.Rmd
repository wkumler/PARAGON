---
title: "Nitrogen's form determines its fate in the North Pacific Subtropical Gyre during PARAGON I"
author:
  - William Kumler
  - Laura T. Carlson
  - Anitra E. Ingalls
  - Other SCOPE collaborators
output: word_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, eval=FALSE)
library(tidyverse)
library(ggh4x)
library(patchwork)
library(ggtext)
library(minpack.lm)
options(pillar.sigfig = 7)
options(pillar.print_min = 100)
```

```{r load data, eval=FALSE}
parametadata <- read_csv("metadata/parametadata.csv") %>%
  # filter(IS_type=="noIS") %>%
  filter(polarity=="pos") %>%
  filter(samp_type=="Smp" | samp_type=="Bad") %>%
  mutate(startime=factor(startime, levels=c("Morn", "Eve"))) %>%
  mutate(depth=factor(depth, levels=c("Surf", "Deep"))) %>%
  mutate(amendment=factor(amendment, levels=c("Amm", "Nit", "Arg", "GMP"))) %>%
  arrange(amendment, depth, timepoint_num, startime) %>%
  mutate(timepoint=factor(timepoint, levels=c("T0", "T1", "T3", "T10", "T18", "T26", "T73")))

all_stans <- read_csv("metadata/all_stans.csv")
stan_patched <- all_stans %>%
  filter(!compound_name=="beta-Glutamic acid") %>%
  mutate(compound_name=str_replace(compound_name, "L-Glutamic acid", "L-Glutamic acid/beta-Glutamic acid")) %>%
  filter(!compound_name=="L-Isoleucine") %>%
  mutate(compound_name=str_replace(compound_name, "L-Leucine", "L-Leucine/L-Isoleucine")) %>%
  filter(!compound_name=="L-Homoserine") %>%
  mutate(compound_name=str_replace(compound_name, "L-Threonine", "L-Threonine/L-Homoserine")) %>%
  filter(!compound_name=="Allopurinol") %>%
  mutate(compound_name=str_replace(compound_name, "Hypoxanthine", "Hypoxanthine/Allopurinol"))
maa_names <- c("Also Palythene/Usujirene?", "Shinorine?", "Mycosporine-glycine?", 
               "Palythine?", "Another Palythene/Usujirene?", "Porphyra-334?", 
               "Also Porphyra-334?", "Asterina-330?", "Palythene/Usujirene?",
               "Mycosporine-2-glycine?")
nucleo_names <- c("5-Methylcytosine", "Adenosine", "Cytidine", "Adenine", "Guanosine",
                  "Cytosine", "Hypoxanthine/Allopurinol", "Guanine", "Deoxycytidine?",
                  "Deoxyadenosine", "Deoxyguanosine?")
betaine_names <- c("beta-Alaninebetaine", "Glycine betaine", "Homarine", "Trigonelline",
                   "Choline", "Glycerophosphocholine", "Homoserine betaine?", 
                   "Threonine betaine?", "Proline betaine",
                   "(3-Carboxypropyl)trimethylammonium", "O-Acetylcarnitine", 
                   "Betonicine", "Acetylcholine", "Phosphocholine")
non_n_names <- c("Dimethylsulfonioacetate", "Dimethylsulfoniopropionate",
                 "Arsenobetaine", "Dimethylsulfoxonium propionate?", "Gonyol",
                 "2-O-alpha-D-Glucosylglycerol")
aa_names <- c("Glutamine", "Aspartic acid", "Glutamic acid/beta-Glutamic acid",
              "Asparagine", "Alanine", "Methionine", "Arginine", "Proline",
              "Lysine", "Threonine/Homoserine", "Serine", "Glycine", "Histidine",
              "Leucine/Isoleucine", "Valine", "Arginine")
bad_cmpds <- c("Melamine", "Uridine", "Itaconic acid?", "Inosine", "Dexpanthenol", 
               "Choline sulfate", "5-Hydroxyectoine", "L-Tyrosine")
class_levels <- c("Glutamine", "Glutamic acid", "Aspartic acid", "Asparagine", "Arginine", 
                  "Other amino acids", "Theanine?", "Citrulline", "Ectoine", "Guanine", 
                  "Guanosine", "Other nucleic acids", "MAAs", "Betaines", "All others")
aa_ncs <- all_stans %>%
  filter(compound_type=="Amino Acid") %>%
  mutate(compound_name=str_remove(compound_name, "^L-")) %>%
  distinct(compound_name, n_C, n_N) %>%
  add_row(compound_name="Phenylalanine", n_C=9, n_N=1)

peak_areas <- read_csv("targeted/all_peak_areas_w_isos.csv") %>%
  left_join(parametadata %>% distinct(filename, shortname))
samp_areas <- parametadata %>%
  filter(samp_type=="Smp") %>%
  distinct(shortname, depth) %>%
  left_join(peak_areas) %>%
  mutate(shortname=fct_inorder(shortname)) %>%
  filter(!compound_name%in%bad_cmpds) %>%
  filter(!(depth=="Deep" & compound_name%in%maa_names)) %>%
  select(-depth)
labeled_fracs <- samp_areas %>%
  mutate(labeled_frac=1-area/sum(area), .by = c("shortname", "compound_name")) %>%
  select(compound_name, iso_name, shortname, labeled_frac) %>%
  filter(str_detect(iso_name, "13C0, 15N0")) %>%
  select(-iso_name)

thaa_quant <- read_csv("thaas/quant_data.csv") %>%
  filter(iso_name!="Proline, 13C3, 15N1")
metathaa <- read_csv("thaas/metathaa.csv") %>%
  mutate(depth=factor(depth, levels=c("Surf", "Deep"))) %>%
  mutate(startime=factor(startime, levels=c("Morn", "Eve")))
```

# Abstract

Nitrogen availability controls productivity in much of the surface ocean and the form of this nitrogen controls who it is available to and how it is used. Here, we explored how four different forms of nitrogen (ammonia, nitrate, arginine, and guanosine monophosphate) were taken up and transformed in the North Pacific Subtropical Gyre using stable isotope labeling metabolomics. We repeated these experiments both at the surface and at the base of the euphotic zone as well as in the morning and evening. We found that ammonia is converted into glutamate in less than 20 minutes and results in labeling throughout the metabolome, though osmolytes like betaines had slow turnover rates. This process was slower at depth but largely independent of time of day. Nitrate amendments resulted in the labeling of only a small subset of molecules such as mycosporine-like amino acids, whose incorporation patterns suggest that this form of nitrogen was available to a subset of the community, likely eukaryotes. The two organic nitrogen amendments labeled the metabolome more slowly than the inorganic forms of nitrogen and showed similar usage at depth and at the surface, hinting at the major role that heterotrophic bacteria likely play in their uptake and use. A large fraction of the organic nitrogen added was remineralized into ammonia and used as glutamate rather than as intact substrates, though labeled arginine was incorporated into proteins directly. These measurements reveal the forms and fluxes of organic nitrogen in the natural environment to provide constraints on biogeochemical models and better characterize the transformations between organic and inorganic nitrogen.

# Introduction

Marine carbon is fixed into biomass very quickly. In most of the surface ocean this flux is controlled by the availability of nitrogen, an element with a complex and incompletely characterized biogeochemical cycle [@Capone2008; @Moore2013; @Hutchins2022]. Organic nitrogen in particular is often treated as a black box despite substantial variability in its bioavailability and chemical nature. While extensive work has been done to characterize the forms and fluxes of nitrogen within the inorganic pool, the equivalent for the organic pool is woefully underdeveloped [@ref, prob NME2008 or Hansell2024, maybe @Hutchins2022 for visual?]. This is largely due to the difficulty of comprehensively measuring the many organic molecules that contain nitrogen in the marine environment [@Boysen2018; @Moran2022]. The bioavailability of the nitrogen atom is in the environment is largely determined by the form of the organic material it composes.

The mechanisms by which dissolved nitrogen becomes biomass and vice versa are major factors in our ability to predict ecosystem productivity and therefore carbon fixation and export. Traditionally, the conversion of inorganic material into organic substrate was thought to be limited to autotrophs while remineralization was performed by the heterotrophic community. Today, it’s known that many photosynthetic organisms are able to take up and use organic nitrogen [@Anita1991; @Morando2018; @Hugo2021] and that only a select subset of phototrophs are capable of nitrate reduction or nitrogen fixation [@ref], while inorganic nitrogen is directly accessible to heterotrophs as well. This means that the transformations possible for a given N-containing compound are a function of the microbial community and its environment while the microbial community is in turn also expected to be a function of the N-containing molecules available. This creates a recursive network that’s difficult to untangle and cannot necessarily be extrapolated from axenic culture studies.

One way to reveal the pathways and transformations that marine N undergoes in a natural community is via 15N labeling paired with metabolomics. Metabolites that incorporate the labeled nitrogen can then be separated on the mass spectrometer and quantified separately from the unlabeled pool. Here, we trace the uptake and use of labeled ammonia, nitrate, arginine, and guanosine monophosphate in a natural community from the NPSG at multiple depths and diel conditions. Our application of metabolomics to these samples allows us to map out the pathways and restructuring that organic nitrogen experiences in the largest biomes on the planet, quantifying the pool sizes and turnover rates for various low molecular weight compounds that serve as building blocks and intermediates of cell biology.

## Other things to maybe discuss:

  -	mention the expected differences with depth and diel effects
  -	detail which compounds we chose and why?
  -	expand on DON-PON interactions and importance?
  - Extracellular enzymes, organic use as ammonia vs as-is?
  -	expand on the importance of biogeochemical models and why we need pathways mapped out?
  -	mention basic biosynthetic pathways (maybe better suited to discussion?)
  -	new (nitrate) vs regenerated (ammonia and DON) production (maybe also discussion?)

## Other soundbites:
  - It is assumed that most fixed nitrogen becomes protein, presumably based on the large fraction of cell nitrogen in protein and previous research showing how quickly it enters the (free?) amino acid pool. However, 1) important intermediates molecules 2) doesn’t explain where biounavailable N comes from 3) makes gene-based molecular modeling really difficult.
  - In each case, assimilation into organic matter is typically done via the glutamine synthetase (GS)/glutamate synthase (GOGAT) or glutamate dehydrogenase (GDH) pathways to produce glutamate from α-ketoglutarate [@ref, see bronk chapter]. Glutamate then serves as a nitrogen supply in an enormous number of biochemical pathways in both primary and secondary metabolism [@Walker2016].
  - nitrate amendments typically resulting in diatom blooms while ammonia incubations favor cyanobacteria [@Glibert2016].
  - Communities to distinguish are 1) surface (largely regenerated production) and 2) 175m (largely new production(??))
  - use of organics vs synthesis of organics
  - Compounds such as non-proteinogenic amino acids (e.g., ornithine, citrulline, creatine, MAAs), osmolytes like betaines, nucleobases, and sulfur-containing molecules like taurine represent significant but poorly quantified pools. Understanding the rates and pathways by which these compounds are utilized is crucial, as they form the fundamental unit linking genetic potential to elemental cycling in biogeochemical models.
  - Nitrogen use varies significantly between the sunlit surface where productivity is largely regenerated through recycling of ammonia and organic nitrogen, and deeper waters near the base of the euphotic zone, where nitrate supports “new” production. Quantifying rates of nitrogen assimilation into ammonia and downstream products across these gradients is therefore essential for predicting marine productivity and nutrient cycling.
  - Nonetheless, how the community uses a substrate is arguably more important than whether it can. 

# Results

## Differences in nitrogen labeling at the surface between amendments

```{r}
xamend_metab_gp <- labeled_fracs %>%
  left_join(parametadata %>% distinct(shortname, samp_type, timepoint, timepoint_num, depth, startime, amendment, tripl)) %>%
  filter(samp_type!="Bad") %>%
  filter(depth=="Surf") %>%
  mutate(compound_name=str_remove_all(compound_name, "^L-")) %>%
  mutate(compound_name=str_remove(compound_name, "/beta-Glutamic acid")) %>%
  mutate(compound_class=case_when(
    compound_name%in%c("Glutamine", "Aspartic acid", "Asparagine", "Glutamic acid", "Ectoine", "Theanine?", "Citrulline", "Guanine", "Guanosine", "Arginine") ~ compound_name,
    compound_name%in%maa_names~"MAAs",
    compound_name%in%aa_names~"Other amino acids",
    compound_name%in%nucleo_names~"Other nucleic acids",
    compound_name%in%betaine_names~"Betaines",
    TRUE~"All others"
  )) %>%
  mutate(compound_class=factor(compound_class, levels=class_levels)) %>%
  summarise(avg_frac=mean(labeled_frac), .by = c(compound_class, amendment, timepoint, tripl)) %>%
  mutate(amendment=factor(amendment, levels=c("Amm", "Nit", "Arg", "GMP"),
                          labels=c("+Ammonia", "+Nitrate", "+Arginine", "+GMP"))) %>%
  ggplot() +
  geom_raster(aes(x=timepoint, y=tripl, fill=avg_frac)) +
  geom_vline(xintercept = c(1.5:4.5), color="grey80") +
  facet_nested(compound_class~amendment, scales = "free_x", switch="y") +
  scale_fill_gradientn(colours = viridis::viridis(10, alpha = seq(0, 1, length.out=10), direction = -1),
                       limits=c(0, 1), breaks=c(0, 0.25, 0.5, 0.75, 1),
                       labels=c("Fully unlabeled", "", "50% labeled", "", "Fully labeled")) +
  scale_x_discrete(expand = expansion()) +
  scale_y_discrete(expand = expansion()) +
  labs(x=NULL, y=NULL, fill=NULL) +
  theme_bw() +
  theme(panel.spacing.x=unit(0.5, "lines"), 
        panel.spacing.y = unit(0, "lines"),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.y.left = element_text(angle=0, hjust = 1),
        strip.background.y = element_rect(fill=NA, color=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "top", 
        legend.key.width = unit(1, "null")) +
  guides(
    fill=guide_colorbar(theme=theme(
      legend.frame = element_rect(color = "black"),
      legend.ticks = element_line(color="black"),
      legend.text = ggtext::element_markdown(hjust=c(0, 0, 0.5, 1, 1)))
    )
  )
ggsave("xamend_metab_gp.png",plot = xamend_metab_gp, device = "png", path = "manuscript/figures",
       width = 6.5, height = 5.5, units = "in", dpi = 300)
```

![](figures/xamend_metab_gp.png)

*Figure 1: Fraction of each metabolite or metabolite group containing at least one 15N label during the surface seawater amended various substrates after the number of hours shown on the x-axis. Darker colors indicate a larger percentage of the compound signal was isotopically labeled. Three biological replicates are stacked vertically at each timepoint and the categories with multiple entries have been averaged. MAA = mycosporine-like amino acids, GMP = guanosine monophosphate.*

  - Ammonia
    - Really rapid labeling of glutamine/glutamate that aligns nicely with prior work
      - Aspartate labeled faster than glutamate likely due to small aspartate pool size
    - Surprisingly rapid labeling of citrulline that isn't reflected in arginine
      - Pool size problem (arginine >> citrulline)?
      - Indicates that urea cycle is only half-active?
    - Putative annotation of theanine based on labeling patterns
    - Rapid and heavy guanine labeling
      - Potentially being used as a storage compound
    - 10-40% of the N in the THAA (protein) pool ends up labeled by T26 (below)
      - THAAs were 30-50% of total PC (~2 uM, need actual data) and 70-100% PN (~0.35uM)
  - Nitrate
    - Very little labeling, even in glutamate/glutamine
      - Surface community not "expecting" nitrate?
      - Redox problems with surface energy?
    - Guanine and MAA labeling exceeds glutamate labeling
      - Clear sign of a community *subset* using nitrate
        - Specifically the MAA synthesizers (euks) and those storing N in guanine (diatoms/haptos/dinos)
    - More extensive labeling (10-50% of the N) in the THAAs
      - Must be a really high flux through a small AA pool subset, e.g. euks specifically
  - Arginine
    - Clear uptake at T0 (20 minutes), 80-90% of the pool taken up at T10
      - Labeling signal decreases after 24 hours
    - Label obviously making it into citrulline so urea cycle is active
      - Don't really have good enough urea data to see labeling change there?
    - Big jump in labeling of other metabolites at T26 not seen at T10
      - No hypotheses why this is happening but it occurs in both morn/eve so not light signal
    - Maybe less storage in guanine specifically, labeling is on par with other NAs unlike ammonia
    - THAAs show clear usage of arginine in proteins
      - 30-50% arg in THAAs labeled @73hrs
      - Clear reuse of arginine backbone as fully labeled glutamate and proline
  - Guanosine monophosphate
    - Unable to measure GMP well enough directly?
    - Guanosine labeling visible at T3, definitely T10, maybe some decrease at T73 like Arg?
      - Guanosine pool never gets super heavily labeled
    - Has a VERY similar pattern to arginine
      - Also a big jump at T26 with basically no labeling at T10
      - Implies mostly converted into ammonia as well and used that way
    - Reuse of carbon backbone for THAAs though
      - Histidine 13C5, 15N3
      - Tyrosine 13C4, 15N1
      - Phenylalanine 13C4, 15N1

```{r thaa data}
all_thaa_plot <- thaa_quant %>%
  filter(!str_detect(iso_name, "2H")) %>%
  left_join(metathaa) %>%
  filter(samp_type=="Smp") %>%
  left_join(aa_ncs) %>%
  select(filename, compound_name, iso_name, env_conc_nm, n_C, n_N) %>%
  mutate(n_N_lab=as.numeric(str_extract(iso_name, "(?<=15N)\\d+"))) %>%
  mutate(n_N_unlab=n_N-n_N_lab) %>%
  mutate(nM_N_lab=env_conc_nm*n_N_lab, nM_N_unlab=env_conc_nm*n_N_unlab) %>%
  select(filename, compound_name, iso_name, nM_N_lab, nM_N_unlab) %>%
  pivot_longer(c(nM_N_lab, nM_N_unlab)) %>%
  summarise(total_uM=sum(value)/1000, .by=c(filename, name)) %>%
  left_join(metathaa) %>%
  mutate(amendment=ifelse(timepoint=="T0", "T0", amendment)) %>%
  mutate(amendment=factor(amendment, levels = c("T0", "Amm", "Nit", "Arg", "GMP"),
                          labels=c("Initial", "+Ammonia", "+Nitrate", "+Arginine", "+GMP"))) %>%
  summarise(total_uM=mean(total_uM), .by=c(amendment, timepoint, name)) %>%
  mutate(name=factor(name, levels=c("nM_N_unlab", "nM_N_lab"), labels = c("Unlabeled", "Labeled"))) %>%
  ggplot(aes(x=amendment, y=total_uM, fill=name)) +
  geom_col(color="black", width=1) +
  theme_bw() +
  scale_x_discrete(expand = expansion()) +
  scale_y_continuous(expand = expansion(mult=c(0, 0.05))) +
  scale_fill_manual(breaks = c("Unlabeled", "Labeled"), values=c("grey80", "grey20")) +
  labs(x=NULL, y="Total uM N in THAAs", fill=NULL)

plot_iso_levels <- c(
  "Unlabeled", 
  "<sup>15</sup>N<sub>1</sub>", 
  "<sup>15</sup>N<sub>2</sub>", 
  "<sup>15</sup>N<sub>3</sub>", 
  "Entirely <sup>15</sup>N",
  "<sup>13</sup>C<sub>1</sub>", 
  "<sup>13</sup>C<sub>1</sub><sup>15</sup>N<sub>1</sub>",
  "<sup>13</sup>C<sub>4</sub><sup>15</sup>N<sub>1</sub>", 
  "<sup>13</sup>C<sub>5</sub><sup>15</sup>N<sub>3</sub>",
  "Entirely <sup>13</sup>C<br>and <sup>15</sup>N", 
  "Other labels")
plot_iso_colors <- c(
  "grey80",
  "#e0ecf6",
  "#97bfe0",
  "#377EB8",
  "#285b84",
  "#ffb4b5",
  "#d7b6dc",
  "#FFFF33",
  "#4DAF4A",
  "#984EA3",
  "grey20"
)
thaa_spec_cmpds <- c("Glutamine + Glutamate", "Arginine", "Proline", "Histidine", "Phenylalanine", "Tyrosine")
thaa_plot_data <- thaa_quant %>%
  left_join(metathaa) %>%
  filter(samp_type=="Smp") %>%
  mutate(amendment=ifelse(timepoint=="T0", "T0", amendment)) %>%
  summarise(avg_env_conc_nm=mean(env_conc_nm, na.rm=TRUE), .by=c(compound_name, iso_name, amendment, timepoint)) %>%
  mutate(compound_name=ifelse(compound_name=="Glutamic acid", "Glutamine + Glutamate", compound_name)) %>%
  mutate(compound_name=factor(compound_name, levels = thaa_spec_cmpds)) %>%
  filter(!is.na(compound_name)) %>%
  mutate(plot_iso_name=case_when(
    str_detect(iso_name, "13C0, 15N0")~"Unlabeled",
    str_detect(iso_name, "13C0, 15N1")~"<sup>15</sup>N<sub>1</sub>",
    str_detect(iso_name, "13C0, 15N2")~"<sup>15</sup>N<sub>2</sub>",
    str_detect(iso_name, "Histidine, 13C0, 15N3")~"Entirely <sup>15</sup>N",
    str_detect(iso_name, "13C0, 15N3")~"<sup>15</sup>N<sub>3</sub>",
    str_detect(iso_name, "Arginine, 13C0, 15N4")~"Entirely <sup>15</sup>N",
    str_detect(iso_name, "13C1, 15N0")~"<sup>13</sup>C<sub>1</sub>",
    str_detect(iso_name, "13C1, 15N1")~"<sup>13</sup>C<sub>1</sub><sup>15</sup>N<sub>1</sub>",
    str_detect(iso_name, "Glutamic acid, 13C5, 15N1")~"Entirely <sup>13</sup>C<br>and <sup>15</sup>N",
    str_detect(iso_name, "Proline, 13C5, 15N1")~"Entirely <sup>13</sup>C<br>and <sup>15</sup>N",
    str_detect(iso_name, "Arginine, 13C6, 15N4")~"Entirely <sup>13</sup>C<br>and <sup>15</sup>N",
    iso_name=="Tyrosine, 13C4, 15N1"~"<sup>13</sup>C<sub>4</sub><sup>15</sup>N<sub>1</sub>",
    iso_name=="Phenylalanine, 13C4, 15N1"~"<sup>13</sup>C<sub>4</sub><sup>15</sup>N<sub>1</sub>",
    iso_name=="Histidine, 13C5, 15N3"~"<sup>13</sup>C<sub>5</sub><sup>15</sup>N<sub>3</sub>",
    TRUE~"Other labels"
  )) %>%
  mutate(plot_iso_name=factor(plot_iso_name, levels=plot_iso_levels)) %>%
  mutate(amendment=factor(amendment, levels = c("T0", "Amm", "Nit", "Arg", "GMP")))
arg_glut_thaa_plot <- ggplot(thaa_plot_data) +
  geom_col(aes(x=amendment, y=avg_env_conc_nm, fill=plot_iso_name, label=iso_name),
           position="fill",
           color="black", width=1) +
  facet_wrap(~compound_name) +
  theme_bw() +
  scale_x_discrete(expand = expansion()) +
  scale_y_continuous(labels=scales::label_percent(), breaks=c(0, 0.5, 1),
                     expand = expansion()) +
  scale_fill_manual(breaks = plot_iso_levels, values = plot_iso_colors) +
  labs(x=NULL, y="Fraction of THAA labeled", fill=NULL) +
  theme(
    # axis.text.x=element_text(angle=90, hjust=1, vjust = 0.5),
    legend.text = element_markdown()
  )
total_thaa_gp <- all_thaa_plot / arg_glut_thaa_plot + plot_layout(heights = c(0.3, 0.7))
total_thaa_gp
ggsave("total_thaa_gp.png", total_thaa_gp, device = "png", path = "manuscript/figures",
       width = 6.5, height = 5, units = "in", dpi = 300)
```

![](figures/total_thaa_gp.png)

*Figure 2: Stacked bar plots showing the fraction of various total hydrolyzable amino acids (THAAs) labeled at the end of the incubations across the four amendments. Total uM nitrogen (N) in the protein pool is shown in the top plot while the fraction of individual amino acids labeled is shown in the rows below. Colors denote specific labeling patterns detected in the THAAs.*

## Minimal diel signal observed except in the UV-reactive mycosporine-like amino acids

```{r fig MAA labeling new}
chosen_maas <- c("Mycosporine-glycine?", "Shinorine?", "Palythine?",
                 "Palythene/Usujirene?", "Also Palythene/Usujirene?", 
                 "Also Porphyra-334?")
labeled_fracs %>%
  filter(compound_name%in%chosen_maas) %>%
  mutate(compound_name=factor(compound_name, levels=chosen_maas)) %>%
  arrange(compound_name) %>%
  mutate(compound_name=str_remove(compound_name, "\\?$")) %>%
  mutate(compound_name=str_replace(compound_name, "Also Palythene/Usujirene", "Palythene or\n usujirene")) %>%
  mutate(compound_name=str_replace(compound_name, "Palythene/Usujirene", "Usujirene or\n palythene")) %>%
  mutate(compound_name=str_remove(compound_name, "Also ")) %>%
  mutate(compound_name=str_replace(compound_name, "-glycine", "-\nglycine")) %>%
  mutate(compound_name=fct_inorder(compound_name)) %>%
  left_join(parametadata, relationship = "many-to-many") %>%
  filter(samp_type=="Smp") %>%
  filter(IS_type=="noIS") %>%
  filter(amendment%in%c("Amm", "Nit")) %>%
  mutate(amendment=factor(amendment, levels=c("Amm", "Nit"), labels=c("+Ammonia", "+Nitrate"))) %>%
  mutate(clock_time=ifelse(startime=="Morn", 6+timepoint_num, 18+timepoint_num)) %>%
  mutate(startime=factor(startime, levels=c("Morn", "Eve"), labels=c("6AM start", "6PM start"))) %>%
  ggplot() +
  annotate("rect", xmin=-Inf, xmax = 6, ymin=-Inf, ymax=Inf, fill="grey80") +
  # annotate("rect", xmin=6, xmax = 18, ymin=-Inf, ymax=Inf, fill="#d0bd65") +
  annotate("rect", xmin=18, xmax = 30, ymin=-Inf, ymax=Inf, fill="grey80") +
  # annotate("rect", xmin=30, xmax = 42, ymin=-Inf, ymax=Inf, fill="#d0bd65") +
  annotate("rect", xmin=42, xmax = Inf, ymin=-Inf, ymax=Inf, fill="grey80") +
  geom_hline(yintercept = c(0.25, 0.5, 0.75, 1), color="grey90") +
  # annotate("rect", xmin=-Inf, xmax=Inf, ymin=-Inf, ymax = Inf, fill="white", alpha=0.3) +
  geom_smooth(aes(x=clock_time, y=labeled_frac, color=startime),
              method=nlsLM, formula="y~a*x^b+d", se = FALSE,
              method.args=list(start=list(a=1, b=2, d=1),
                               control=nls.lm.control(maxiter = 500))) +
  # geom_smooth(aes(x=clock_time, y=labeled_frac, group=startime),
  #             method=glm, formula = "y~x", method.args=list(family="quasibinomial"), 
  #             color="grey10", se=FALSE) +
  # geom_point(aes(x=clock_time, y=labeled_frac, shape=startime), color="black", 
  #            fill="white", size=3) +
  geom_point(aes(x=clock_time, y=labeled_frac, shape=startime, fill=startime),
             color="black", size=2, alpha=0.7) +
  facet_nested(compound_name~amendment) +
  scale_x_continuous(breaks = c(6, 18, 30, 42), labels = c("6AM", "6PM", "6AM", "")) +
  scale_y_continuous(labels = scales::label_percent(),
                     limits = c(0, 1), breaks = c(0, 0.5, 1)) +
  scale_shape_manual(values=c(24, 25), breaks = c("6AM start", "6PM start")) +
  scale_fill_manual(values=c("#f4bb23", "#0b505c"), breaks = c("6AM start", "6PM start"),
                    aesthetics = c("color", "fill")) +
  labs(x=NULL, color=NULL, shape=NULL, fill=NULL, y="Fraction of MAA containing at least one 15N atom") +
  theme_bw() +
  theme(axis.text.y = element_markdown(vjust=c(0, 0.5, 1)),
        axis.title.x = element_blank(),
        legend.position = "inside",
        legend.margin = margin(0.1,0.25,0.1,0.1, unit="lines"),
        legend.position.inside = c(1, 1),
        legend.justification = c(1, 1), 
        legend.background = element_rect(fill="#FFFFFFAA", color="black", linewidth = 0)) +
  guides(shape=guide_legend(override.aes = list(size=3, stroke=1.2, alpha=1, linetype=0)))

ggsave(filename = "MAA_curves.png", device = "png", path = "manuscript/figures",
       width = 3, height = 6, units = "in", dpi = 300)
```

![](figures/MAA_curves.png)

*Figure 3: Fraction of UV-reactive mycosporine-like amino acids (MAAs) containing at least one 15N label over one day during the treatments amended with 15N labeled ammonia or nitrate. Incubations started at 6AM are shown in yellow while incubations started at 6PM are shown in blue, with grey background regions highlighting nighttime. Three replicates are included at each of the 5 timepoints and best-fit power law curves have been fit behind the data.*

  - MAAs clearly show daytime synthesis during the day and not at night
    - Very clear in +Ammonia, less so in +Nitrate
    - Need to show this statistically somehow?
  - High levels of labeling despite minimal glycine labeling and synthesis being 4DG+Gly for these
  - Putative annotations based on labeling pattern (and only found at surface)
    - Maybe also can do a search for fragments

## Inorganics more bioavailable at surface, organics equally bioavailable at 25m and 175m

```{r fig surface vs deep labeling rates}
surfdeep_demo_cmpd_gp <- labeled_fracs %>%
  mutate(compound_name=str_remove_all(compound_name, "^L-")) %>%
  mutate(compound_name=str_remove(compound_name, "/beta-Glutamic acid")) %>%
  mutate(compound_class=case_when(
    compound_name%in%c("Glutamine", "Aspartic acid", "Asparagine", "Glutamic acid", "Ectoine", "Theanine?", "Citrulline", "Guanine", "Guanosine", "Arginine") ~ compound_name,
    compound_name%in%aa_names~"Other amino acids",
    compound_name%in%nucleo_names~"Other nucleic acids",
    compound_name%in%betaine_names~"Betaines",
    TRUE~"All others"
  )) %>%
  mutate(compound_class=factor(compound_class, levels=setdiff(class_levels, "MAAs"))) %>%
  left_join(parametadata %>% distinct(shortname, timepoint_num, depth, startime, amendment, tripl)) %>%
  filter(timepoint_num!=18) %>%
  filter(compound_name=="Glutamic acid" & amendment=="Amm" |
           compound_name=="Arginine" & amendment=="Arg" |
           compound_name=="Guanosine" & amendment=="GMP") %>%
  mutate(timepoint_num=ifelse(timepoint_num==0, 0.3, timepoint_num)) %>%
  mutate(amendment=factor(amendment, levels=c("Amm", "Arg", "GMP"),
                          labels=c("+Ammonia", "+Arginine", "+GMP"))) %>%
  select(-shortname) %>%
  summarise(mean_label=mean(labeled_frac), .by=c(compound_class, amendment, timepoint_num, depth)) %>%
  pivot_wider(names_from=depth, values_from=mean_label) %>%
  ggplot(aes(x=timepoint_num, color=compound_class, shape=compound_class)) +
  geom_segment(aes(xend=timepoint_num, y=Surf, yend=Deep), lwd=1) +
  geom_point(aes(y=Surf), fill="grey80", size=3, stroke=1) +
  geom_point(aes(y=Deep), fill="grey20", size=3, stroke=1) +
  stat_summary(aes(y=Surf, label=paste0(round(Surf-Deep, 2)*100, "%"), vjust=-sign(Surf-Deep)*1.5+0.75), 
               geom = "text", fun = mean) +
  facet_wrap(~amendment, nrow=1) +
  scale_color_discrete(drop=FALSE) +
  scale_x_log10(breaks=c(0.3, 3, 30), labels=c("0.3", "3", "30"), expand=expansion(0.15)) +
  scale_y_continuous(labels=scales::label_percent(), expand=expansion(mult=c(0, 0.1)),
                     breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  scale_shape_manual(breaks=c("Glutamic acid", "Arginine", "Guanosine"), values=c(22, 25, 21)) +
  labs(x="Hours after <sup>15</sup>N spike", color=NULL, fill=NULL, shape=NULL,
       y="Percent metabolite\nlabeled") +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "none"
  )

surfdeep_all_cmpd_gp <- labeled_fracs %>%
  left_join(parametadata %>% distinct(shortname, timepoint, timepoint_num, depth, startime, amendment, tripl)) %>%
  filter(timepoint_num!=18) %>%
  filter(!compound_name%in%maa_names) %>%
  mutate(compound_name=str_remove_all(compound_name, "^L-")) %>%
  mutate(compound_name=str_remove(compound_name, "/beta-Glutamic acid")) %>%
  mutate(compound_class=case_when(
    compound_name%in%c("Glutamine", "Aspartic acid", "Asparagine", "Glutamic acid", "Ectoine", "Theanine?", "Citrulline", "Guanine", "Guanosine", "Arginine") ~ compound_name,
    compound_name%in%aa_names~"Other amino acids",
    compound_name%in%nucleo_names~"Other nucleic acids",
    compound_name%in%betaine_names~"Betaines",
    TRUE~"All others"
  )) %>%
  mutate(compound_class=factor(compound_class, levels=class_levels)) %>%
  summarise(avg_frac=mean(labeled_frac), .by = c(compound_class, amendment, timepoint_num, depth, tripl)) %>%
  filter(amendment!="Nit") %>%
  summarise(avg_label=mean(avg_frac), .by=c(compound_class, amendment, depth, timepoint_num)) %>%
  pivot_wider(names_from = depth, values_from=avg_label) %>%
  mutate(timepoint_num=ifelse(timepoint_num==0, 0.3, timepoint_num)) %>%
  mutate(amendment=factor(amendment, levels=c("Amm", "Arg", "GMP"),
                          labels=c("+Ammonia", "+Arginine", "+GMP"))) %>%
  ggplot(aes(x=timepoint_num, y=Surf-Deep, color=compound_class, 
             fill=compound_class, shape=compound_class)) +
  geom_line(lwd=0.8) +
  geom_point(color="black", size=3) +
  geom_hline(yintercept = 0) +
  facet_wrap(~amendment, nrow=1) +
  scale_x_log10(breaks=c(0.3, 3, 30), labels=c("0.3", "3", "30"), expand=expansion(0.15)) +
  scale_y_continuous(labels=scales::label_percent()) +
  scale_shape_manual(breaks=setdiff(class_levels, "MAAs"), values = rep(21:25, length.out=14)) +
  labs(x="Hours after <sup>15</sup>N spike", color=NULL, fill=NULL, shape=NULL,
       y="Percent metabolite labeled at 25m\nminus percent labeled at 175m") +
  theme_bw() +
  theme(
    # axis.title.x = element_markdown(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    strip.text = element_blank(),
    strip.background = element_blank()
  )


surfdeep_all_cmpd_boxplot_gp <- labeled_fracs %>%
  left_join(parametadata %>% distinct(shortname, timepoint_num, depth, startime, amendment, tripl)) %>%
  filter(timepoint_num!=18) %>%
  filter(!compound_name%in%maa_names) %>%
  filter(amendment!="Nit") %>%
  mutate(timepoint_num=ifelse(timepoint_num==0, 0.3, timepoint_num)) %>%
  summarise(labeled_frac=mean(labeled_frac), .by=c(timepoint_num, compound_name, depth, amendment)) %>%
  ggplot(aes(x=timepoint_num, y=labeled_frac, group=interaction(timepoint_num, depth), fill=depth)) +
  geom_boxplot(color="black", outlier.shape=21) +
  facet_wrap(~amendment, nrow=1) +
  scale_x_log10(breaks=c(0.3, 3, 30), labels=c("0.3", "3", "30"), expand=expansion(0.15/2)) +
  scale_y_continuous(labels = scales::label_percent(), breaks=c(0, 0.5, 1)) +
  scale_fill_manual(breaks=c("Surf", "Deep"), values=c("grey90", "grey30"), labels=c("25 meters", "175 meters")) +
  labs(x="Hours after <sup>15</sup>N spike", color=NULL, fill=NULL, shape=NULL,
       y="Percent metabolite\nlabeled") +
  theme_bw() +
  theme(
    axis.title.x = element_markdown(),
    strip.text = element_blank(),
    strip.background = element_blank()
  )


surfdeep_gp <- surfdeep_demo_cmpd_gp / surfdeep_all_cmpd_gp / surfdeep_all_cmpd_boxplot_gp + plot_layout(guides = "collect", heights = c(0.3, 0.5, 0.2))

ggsave(filename = "deep_vs_surf_labeling.png", surfdeep_gp, device = "png", 
       path = "manuscript/figures", width = 6.5, height = 6.5, units = "in", dpi = 300)
```

![](figures/deep_vs_surf_labeling.png)

*Figure 4: Plots of the metabolite fraction labeled at the surface (25 meters) and the fraction labeled at 175 meters. Incubations with added ammonia, arginine, and guanosine monophosphate (GMP) are shown. Top row of plots show the calculation of % labeled at 25 meters minus % labeled at 175 meters for three example compounds. All compounds are shown in the middle row of plots, grouped by chemical similarity and labeling pattern where positive values indicate increased synthesis in the surface samples relative to those at depth. Finally, the bottom row of plots shows the relative difference between the surface and deep as boxplots for all compounds without aggregating. Points in the first two rows are the average of six biological replicates (incubations started in the morning and the evening are combined here for additional power) while points in the bottom row denote metabolites with labeled fractions falling outside 1.5 times the interquartile range.*

  - Ammonia incubations result in much faster labeling at 25 meters than 175m
    - Presumed to be a phototrophic signal
    - Major exception is ectoine, a bacterial biosignal (McParland 2021)
  - Organic N incubations result in equal amounts of labeling at surface and depth
    - Ectoine again predominantly labeled at depth
    - Labeling of guanosine at T0 in the +GMP treatment implies rapid uptake and P-cleavage
  - Nitrate data unavailable due to T10 and T26 deep samples contaminated
    - See supplemental figure 1 for the data anyway

## Other results from untargeted analysis

```{r source multicore}
source("untargeted/xcms_multicore.R")
```

```{r load clean_combined and make feat_shape_df}
cleaned_combined_peaks <- readRDS("untargeted/cleaned_combined_peaks.rds")
lmtest_output <- cleaned_combined_peaks %>%
  arrange(feature) %>%
  select(feature, filename, into) %>%
  left_join(parametadata) %>%
  filter(samp_type=="Smp") %>%
  mutate(timepoint_num=ifelse(timepoint_num==0, 0.3, timepoint_num)) %>%
  nest(data=-feature) %>%
  filter(sapply(data, nrow)>2) %>%
  mutate(lm_test=map(data, ~broom::tidy(lm(log10(.x$into)~log10(.x$timepoint_num))), .progress = TRUE)) %>%
  unnest(lm_test) %>%
  filter(term=="log10(.x$timepoint_num)") %>%
  mutate(p_adj=p.adjust(p.value, method = "fdr"))

feat_shape_df <- cleaned_combined_peaks %>%
  summarise(mzmed=unique(mzmed),
            rtmed=unique(rtmed),
            med_iso_cor=median(iso_cor), 
            med_snr=median(beta_snr),
            med_cor=median(beta_cor),
            .by=feature) %>%
  left_join(lmtest_output %>% select(feature, estimate, p_adj)) %>%
  mutate(peak_qual=ifelse(med_snr>-50*med_cor+50, "Good", "Bad")) %>%
  mutate(peak_qual=ifelse(rtmed<2*60 | between(rtmed, 14*60, 14.5*60), "Solvent artifact", peak_qual)) %>%
  mutate(is_iso=ifelse(med_iso_cor>0.8, "Is iso", "Not iso")) %>%
  mutate(time_trend=ifelse(p_adj<0.001& estimate>0, "Increases", "No change"))
feat_shape_df %>%
  filter(!is.na(time_trend)) %>%
  count(peak_qual, is_iso, time_trend)
```

```{r get counts per amendment instead of as a whole}
# Repeat analysis across amendments to get additional numbers
lmtest_xamend <- cleaned_combined_peaks %>%
  arrange(feature) %>%
  select(feature, filename, into) %>%
  mutate(samp_type=str_extract(filename, "Smp|Blk|Poo")) %>%
  filter(samp_type=="Smp") %>%
  mutate(timepoint=as.numeric(str_extract(filename, "(?<=T)\\d+"))) %>%
  mutate(timepoint=ifelse(timepoint==0, 0.3, timepoint)) %>%
  mutate(amendment=str_extract(filename, "Amm|GMP|Arg|Nit")) %>%
  mutate(depth=str_extract(filename, "Surf|Deep")) %>%
  nest(data=-c(feature, amendment)) %>%
  filter(sapply(data, nrow)>2) %>%
  mutate(lm_test=map(data, ~broom::tidy(lm(log10(.x$into)~log10(.x$timepoint))), .progress = TRUE)) %>%
  unnest(lm_test) %>%
  filter(term=="log10(.x$timepoint)") %>%
  mutate(p_adj=p.adjust(p.value, method = "fdr"))
feat_shape_df_xamend <- cleaned_combined_peaks %>%
  mutate(amendment=str_extract(filename, "Amm|GMP|Arg|Nit")) %>%
  summarise(mzmed=unique(mzmed),
            rtmed=unique(rtmed),
            med_iso_cor=median(iso_cor), 
            med_snr=median(beta_snr),
            med_cor=median(beta_cor),
            .by=c(feature, amendment)) %>%
  left_join(lmtest_xamend %>% select(feature, amendment, estimate, p_adj)) %>%
  mutate(peak_qual=ifelse(med_snr>-50*med_cor+50, "Good", "Bad")) %>%
  mutate(is_iso=ifelse(med_iso_cor>0.8, "Is iso", "Not iso")) %>%
  mutate(time_trend=ifelse(p_adj<0.001& estimate>0, "Increases", "No change"))
feat_shape_df_xamend %>%
  bind_rows(iso_df %>% mutate(amendment="Overall")) %>%
  # filter(!rtmed%between%(c(14, 14.5)*60)) %>%
  # filter(!rtmed<(2*60)) %>%
  filter(!is.na(time_trend)) %>%
  count(peak_qual, is_iso, time_trend, amendment) %>%
  pivot_wider(names_from = amendment, values_from=n, values_fill = 0) %>%
  print()
feat_shape_df_xamend %>%
  bind_rows(feat_shape_df %>% mutate(amendment="Overall")) %>%
  filter(!is.na(time_trend)) %>%
  ggplot() +
  geom_bar(aes(x=amendment)) +
  facet_wrap(~peak_qual+is_iso+time_trend, scales="free_y", ncol=4)
```

```{r write out the best labels for manual annotation}
best_labeled <- feat_shape_df %>%
  filter(peak_qual=="Good" & is_iso=="Is iso" & time_trend=="Increases") %>%
  arrange(feature) %>%
  select(feature, mzmed, rtmed, med_iso_cor, med_snr, med_cor, p_adj)
psb_stans <- all_stans %>%
  filter(polarity=="pos") %>%
  summarise(compound_name=paste(compound_name, collapse = "/"), .by = mz) %>%
  rowwise() %>%
  mutate(N15_mz_lower=pmppm(mz+0.997035, 10)[1]) %>%
  mutate(N15_mz_upper=pmppm(mz+0.997035, 10)[2]) %>%
  select(compound_name, N15_mz_lower, N15_mz_upper)
best_labeled %>%
  left_join(psb_stans, join_by(between(x$mzmed, y$N15_mz_lower, y$N15_mz_upper))) %>%
  select(-N15_mz_lower, -N15_mz_upper) %>%
  mutate(compound_name=ifelse(duplicated(compound_name)&!is.na(compound_name), "Isocytosine", compound_name)) %>%
  mutate(compound_name=ifelse((mzmed-lag(mzmed))%between%c(0.996, 0.998), "iso_prev?", compound_name)) %>%
  mutate(rtmed=rtmed/60) %>%
  select(feature, mzmed, rtmed, compound_name) %>%
  write_csv("untargeted/best_labeled_anno.csv")
```

```{r heatmap of all high-quality feats}
high_qual_feats <- cleaned_combined_peaks %>%
  filter(rtmed>120 & !rtmed%between%c(14*60, 14.5*60)) %>%
  left_join(parametadata %>% distinct(filename, samp_type)) %>%
  filter(samp_type=="Smp") %>%
  summarise(med_iso_cor=median(iso_cor), 
            med_snr=median(beta_snr),
            med_cor=median(beta_cor),
            .by=c(feature)) %>%
  filter(med_snr>-50*med_cor+50) %>%
  filter(med_iso_cor>0.8)
untarg_lab_fracs <- cleaned_combined_peaks %>%
  filter(feature%in%high_qual_feats$feature) %>%
  select(feature, filename, lab_area, unlab_area) %>%
  left_join(parametadata %>% distinct(filename, samp_type)) %>%
  filter(samp_type=="Smp") %>%
  slice_max(unlab_area, by=c(feature, filename), with_ties = FALSE) %>%
  mutate(labeled_frac=lab_area/(lab_area+unlab_area)) %>%
  left_join(parametadata %>% distinct(filename, shortname)) %>%
  select(feature, shortname, labeled_frac)

cmpd_order <- untarg_lab_fracs %>%
  summarise(mean_label=mean(labeled_frac, na.rm=TRUE), .by=feature) %>%
  arrange(desc(mean_label)) %>%
  pull(feature)

colorpal <- viridis::viridis(10, alpha=seq(0, 1, length.out=10), direction = -1)
untarg_heatmap <- untarg_lab_fracs %>%
  complete(feature, shortname, fill=list(labeled_frac=0)) %>%
  mutate(feature=factor(feature, levels=cmpd_order)) %>%
  left_join(parametadata %>% filter(IS_type=="noIS")) %>%
  ggplot() +
  geom_raster(aes(x=timepoint, y=tripl, fill=labeled_frac)) +
  scale_fill_gradientn(colours = colorpal, limits = c(0, 1)) +
  scale_y_discrete(expand=expansion()) +
  scale_x_discrete(guide = guide_axis(n.dodge = 5), expand=expansion()) +
  facet_nested(feature~amendment+depth+startime, scales = "free_x", switch="y", strip=strip_nested(size = "variable")) +
  labs(x="Timepoint", y="Metabolite", fill="Fraction\nlabeled") +
  theme_bw() +
  theme(panel.spacing.x=unit(0.2, "lines"), 
        panel.spacing.y = unit(0, "lines"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        # axis.ticks.length.x=unit(1:5, "lines"),
        # axis.text.x = element_markdown(vjust = -5:-1),
        strip.text.y.left = element_text(angle=0, hjust = 1),
        # strip.background.y = element_rect(fill=NA, color=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "top", 
        legend.key.width = unit(1, "null")) +
  guides(
    fill=guide_colorbar(theme=theme(
      legend.frame = element_rect(color = "black"),
      legend.ticks = element_line(color="black"),
      legend.text = ggtext::element_markdown(hjust=c(0, 0.5, 0.5, 0.5, 1)))
    )
  )
ggsave("untargeted/untarg_heatmap.pdf", width = 10, height=36, units = "in")
```

```{r run kmeans}
untarg_lab_mat <- untarg_lab_fracs %>%
  bind_rows(labeled_fracs %>% rename(feature=compound_name)) %>%
  pivot_wider(names_from = "feature", values_from = "labeled_frac", values_fill=0) %>%
  column_to_rownames("shortname") %>%
  data.matrix()

set.seed(124)

# sapply(1:20, function(n_clust){
#   replicate(10, {
#     kmeans_out <- kmeans(t(untarg_lab_mat), centers = n_clust)
#     kmeans_out$betweenss / kmeans_out$totss * 100
#   })
# }) %>%
#   boxplot()

n_clust <- 10
untarg_kmeans <- untarg_lab_mat %>%
  t() %>%
  kmeans(centers = n_clust)
kmeans_df <- data.frame(cluster=1:n_clust, n=untarg_kmeans$size) %>%
  arrange(desc(n)) %>%
  mutate(cluster_name=paste0("Cluster ", row_number(), " n=", n)) %>%
  mutate(cluster_name=fct_inorder(cluster_name)) %>%
  left_join(data.frame(cluster=untarg_kmeans$cluster, feature=names(untarg_kmeans$cluster))) %>%
  select(cluster_name, feature)

# Plot clusters as heatmap
untarg_lab_fracs %>%
  left_join(kmeans_df) %>%
  summarise(labeled_frac=mean(labeled_frac), .by = c(cluster_name, shortname)) %>%
  left_join(parametadata) %>%
  ggplot() +
  geom_raster(aes(x=timepoint, y=tripl, fill=labeled_frac)) +
  scale_fill_gradientn(colours = colorpal, limits = c(0, 1)) +
  facet_wrap(cluster_name~amendment+depth+startime) +
  scale_y_discrete(expand=expansion()) +
  scale_x_discrete(guide = guide_axis(n.dodge = 5), expand=expansion()) +
  facet_nested(cluster_name~amendment+depth+startime, scales = "free_x", switch="y", 
               strip=strip_nested(size = "variable")) +
  labs(x="Timepoint", y=NULL, fill="Fraction\nlabeled") +
  theme_bw() +
  theme(panel.spacing.x=unit(0.2, "lines"), 
        panel.spacing.y = unit(0, "lines"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        # axis.ticks.length.x=unit(1:5, "lines"),
        # axis.text.x = element_markdown(vjust = -5:-1),
        strip.text.y.left = element_text(angle=0, hjust = 1),
        # strip.background.y = element_rect(fill=NA, color=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "top", 
        legend.key.width = unit(1, "null")) +
  guides(
    fill=guide_colorbar(theme=theme(
      legend.frame = element_rect(color = "black"),
      legend.ticks = element_line(color="black"),
      legend.text = ggtext::element_markdown(hjust=c(0, 0.5, 0.5, 0.5, 1)))
    )
  )

# Export as CSV
kmeans_df %>%
  filter(!startsWith(feature, "FT")) %>%
  arrange(cluster_name, feature) %>%
  split(.$cluster_name) %>%
  map(function(df_i){
    df_i %>% add_row(cluster_name="", feature="")
  }) %>%
  bind_rows() %>%
  write_csv("untargeted/cluster_assignments.csv")
```

# Discussion

# Conclusion

# Methods

# Acknowledgements

# Data availability

# References

```{r packages, eval=FALSE}
packages_used <- list.files(pattern = "*\\.R$|*\\.Rmd$", recursive = TRUE, full.names = TRUE) %>%
  str_subset("old|scripts", negate=TRUE) %>%
  map(function(file_name){
    v <- readLines(file_name)
    libs <- unique(str_extract(v, "(?<=library\\().*?(?=\\)|,)"))
    refs <- unique(str_extract(v, "[[:alnum:]]*(?=::)"))
    pkgs <- unique(c(na.omit(libs), na.omit(refs)))
  }, .progress = TRUE) %>% unlist() %>% unique()
knitr::write_bib(packages_used[nchar(packages_used)>0], file = "manuscript/r-packages.bib")
```

<div id="refs"></div>

# Supplement

## Supp fig: full heatmap of all compounds and timepoints

```{r suppfig full heatmap}
cmpd_order <- labeled_fracs %>%
  left_join(parametadata, relationship = "many-to-many") %>%
  filter(amendment=="Amm") %>%
  filter(depth=="Surf") %>%
  filter(startime=="Morn") %>%
  summarise(mean_label=mean(labeled_frac, na.rm=TRUE), .by=compound_name) %>%
  arrange(desc(mean_label)) %>%
  pull(compound_name) %>%
  str_remove_all("^L-|(?<=/)L-") %>%
  c("5-Methylcytosine")

heatmap_gp <- labeled_fracs %>%
  left_join(parametadata, relationship = "many-to-many") %>%
  arrange(amendment, depth, timepoint_num, startime) %>%
  mutate(shortname=fct_inorder(shortname)) %>%
  mutate(amendment=factor(amendment, levels=c("Amm", "Nit", "Arg", "GMP"),
                          labels = c("+Ammonia", "+Nitrate", "+Arginine", "+GMP"))) %>%
  mutate(depth=factor(depth, levels=c("Surf", "Deep"), labels=c("25m", "175m"))) %>%
  mutate(compound_name=str_remove_all(compound_name, "^L-|(?<=/)L-")) %>%
  mutate(order_name=factor(compound_name, cmpd_order)) %>%
  mutate(compound_class=case_when(
    compound_name%in%maa_names~"MAA",
    compound_name%in%aa_names~"Amino\nacid",
    compound_name%in%nucleo_names~"Nucleic\nacid",
    compound_name%in%non_n_names~"N-free",
    compound_name%in%betaine_names~"Betaine",
    TRUE~"Other"
  )) %>%
  mutate(compound_class=factor(compound_class, levels=c("Amino\nacid", "Nucleic\nacid", "MAA", "Betaine", "N-free", "Other"))) %>%
  # filter(compound_class=="Other") %>%
  ggplot() +
  geom_raster(aes(x=timepoint, y=tripl, fill=labeled_frac)) +
  scale_fill_gradientn(colours = viridis::viridis(10, alpha = seq(0, 1, length.out=10), direction = -1), limits=c(0, 1), breaks=c(0, 0.25, 0.5, 0.75, 1), labels=c("0%<br>(Unlabeled)", "", "50%", "", "100%<br>(Fully labeled)")) +
  scale_y_discrete(expand=expansion()) +
  scale_x_discrete(guide = guide_axis(n.dodge = 5), expand=expansion()) +
  facet_nested(compound_class+compound_name~amendment+depth+startime, scales = "free_x", switch="y", strip=strip_nested(size = "variable")) +
  labs(x="Timepoint", y="Metabolite", fill="Fraction\nlabeled") +
  theme_bw() +
  theme(panel.spacing.x=unit(0.2, "lines"), 
        panel.spacing.y = unit(0, "lines"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        # axis.ticks.length.x=unit(1:5, "lines"),
        # axis.text.x = element_markdown(vjust = -5:-1),
        strip.text.y.left = element_text(angle=0, hjust = 1),
        # strip.background.y = element_rect(fill=NA, color=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "top", 
        legend.key.width = unit(1, "null")) +
  guides(
    fill=guide_colorbar(theme=theme(
      legend.frame = element_rect(color = "black"),
      legend.ticks = element_line(color="black"),
      legend.text = ggtext::element_markdown(hjust=c(0, 0.5, 0.5, 0.5, 1)))
    )
  )

ggsave(plot = heatmap_gp, "manuscript/supplement/para_heatmap.pdf", device = "pdf",
       width = 10, height = 12)
```


## Supp fig: THAA labeling broken down by triplicate

```{r thaa supplement figures}
pdf("manuscript/supplement/THAA_labeling.pdf", width=9, height = 5)
for(cmpd_i in setdiff(unique(thaa_quant$compound_name), c("Citrulline", "Ornithine", "Taurine"))){
  print(cmpd_i)
  gp <- thaa_quant %>%
    filter(compound_name==cmpd_i) %>%
    left_join(metathaa, by = join_by(filename)) %>%
    drop_na() %>%
    ggplot() +
    geom_col(aes(x=tripl, y=env_conc_nm, fill=iso_name), 
             position="fill",
             color="black", width=1) +
    facet_nested(depth+startime~amendment+timepoint) +
    scale_y_continuous(labels = scales::label_percent()) +
    theme_bw() +
    ggtitle(cmpd_i) +
    labs(x="Biological triplicate", y="Fraction labeled", fill="Isotopologue")
  print(gp)
}
dev.off()
```
